<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width" />
  <title>tsfm-ex</title>
  <style>
body {
    background-color: black;
    color: #12abef;
    font-family: 'Noto Sans Mono CJK JP','Source Han Code JP', monospace;
}
pre {
    font-size:1em;
    font-family: 'Noto Sans Mono CJK JP','Source Han Code JP', monospace;
}
.form{
    display:inline-block;
    width: 100%;
    height: 1em;
    outline: none;
}
#terminal{
    overflow:scroll;
    height:100vh;
    white-space: nowrap;
}

  </style>
</head>
<body>
  <div id="terminal" onclick = "form.focus()"></div>
  <script>
    console.log("start");
    var terminal = document.getElementById("terminal");
    var log = document.getElementById("log");
    var checker = false;
    var elements = {}
    var ans;
    var form;
    var nodes=[];
    var keyPressed = false;
    var pressedKey = "";
    var keyGetting = false;
    function logKey(e) {
      console.log(e.code);
      if(e.code=="Enter"){
        elements.input = form.innerText;
        form.contentEditable = false;
        form.removeEventListener('keydown', logKey)
        checker = true;
      }
      console.log(elements);
    }
    function give(str){
      elements = JSON.parse(str)
      return 0;
    }
    function get(){
      return JSON.stringify(elements);
    }
    function check(){
      return checker;
    }
    function print(obj){
      var line = document.createElement("div");
      var result = NaN;
      for(var n=0;n<obj.length;n++){
        if(obj[n].tag){
          var span = document.createElement(obj[n].tag);
        }else{
          var span = document.createElement("span");
        }
        if(obj[n].getKey){
          endGetKey();
          form = span;
          span.className = "form";
          span.contentEditable = true;
          span.addEventListener('keydown', getKey);
          keyGetting = true;
        }
        span.style=obj[n].style;
        span.innerHTML=obj[n].str;
        line.append(span);
        if(obj[n].edit){
          nodes.push(span);
          result = nodes.length-1;
        }
      }
      terminal.append(line);
      if(keyGetting){
        form.focus();
      }
      return result;
    }
    function edit(num, obj){
      nodes[num].style=obj.style;
      nodes[num].innerHTML=obj.str;
      return 0;
    }
    function delnode(num){
      nodes[num].remove();
      delete nodes[num];
      return 0;
    }
    function getKey(e){
      pressedKey = e.code;
      keyPressed = true;
    }
    function tellKey(){
      keyPressed = false;
      return pressedKey;
    }
    function endGetKey(){
      if(keyGetting){
        form.contentEditable = false;
        form.removeEventListener('keydown', getKey)
      }
    }
    function load(){
      console.log(elements);
        checker = false;
      if(elements.output){
        print(elements.output);
      }
      endGetKey();
      var line = document.createElement("div");
      var left = document.createElement("span");
      left.innerHTML = `${elements.name}:${elements.space}:${elements.pass.replace(elements.doc, "Document")} $ `;
      var right = document.createElement("span");
      right.contentEditable = true;
      right.className = "form"
      line.append(left);
      line.append(right);
      form = right;
      form.addEventListener('keydown', logKey);
      terminal.append(line);
      form.focus();
      return 0;
    }
    console.log("setupend");
    
  </script>
</body>
</html>
